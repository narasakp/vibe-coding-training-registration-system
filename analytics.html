<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Analytics - ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏ö‡∏£‡∏° AI ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .analytics-container { max-width: 1600px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.8rem; font-weight: 700; margin-bottom: 10px; }
        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white; padding: 12px 24px; border-radius: 25px;
            cursor: pointer; font-family: 'Kanit', sans-serif;
            transition: all 0.3s ease;
        }
        .tab-button.active, .tab-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px; padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            margin-bottom: 20px;
        }
        .chart-title { font-size: 1.4rem; font-weight: 600; color: #333; margin-bottom: 20px; text-align: center; }
        .loading { text-align: center; color: white; font-size: 1.2rem; padding: 50px; }
        .error { background: rgba(220, 53, 69, 0.1); color: #dc3545; padding: 20px; border-radius: 10px; text-align: center; }
    </style>
</head>
<body>
    <div class="analytics-container">
        <div class="header">
            <h1>üìä Advanced Analytics</h1>
            <p>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏ö‡∏£‡∏° AI ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î</p>
        </div>

        <div class="nav-tabs">
            <button class="tab-button active" onclick="showTab('overview')">üìà ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
            <button class="tab-button" onclick="showTab('trends')">üìä ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</button>
            <button class="tab-button" onclick="showTab('insights')">üí° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</button>
        </div>

        <div id="loading" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="overview" class="tab-content active">
            <div class="chart-card">
                <div class="chart-title">üìà ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤</div>
                <canvas id="timelineChart"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">üë• ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå</div>
                <canvas id="experienceChart"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">üíª ‡∏†‡∏≤‡∏©‡∏≤‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</div>
                <canvas id="languagesChart"></canvas>
            </div>
        </div>

        <div id="trends" class="tab-content">
            <div class="chart-card">
                <div class="chart-title">üìä ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
                <canvas id="weeklyChart"></canvas>
            </div>
        </div>

        <div id="insights" class="tab-content">
            <div class="chart-card">
                <div class="chart-title">üí° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</div>
                <div id="insights-content">
                    <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyRrQGPIW8WBG_7xUvx7YjCFr1_cWr2I2njtjya1cQawhrS14EX0fYFfFZkQ71tXIN8/exec';
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadAnalyticsData() {
            if (APPS_SCRIPT_URL.includes('YOUR_GOOGLE_APPS_SCRIPT_URL_HERE')) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏Ç‡∏≠‡∏á Google Apps Script';
                return;
            }

            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=stats`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                displayAnalyticsData(data);
                document.getElementById('loading').style.display = 'none';

            } catch (err) {
                console.error('Error loading analytics data:', err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`;
            }
        }

        let charts = {};

        function displayAnalyticsData(data) {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ
            createTimelineChart(data.registrationsByDay || {});
            createExperienceChart(data.byExperience || {});
            createLanguagesChart(data.byLanguages || {});
            createWeeklyChart(data.registrationsByDay || {});
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å
            const insights = document.getElementById('insights-content');
            insights.innerHTML = `
                <div style="padding: 20px; background: #f8f9fa; border-radius: 10px; margin: 10px 0;">
                    <h3>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
                    <p><strong>‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${data.totalRegistrations || 0} ‡∏Ñ‡∏ô</p>
                    <p><strong>‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°:</strong> ${Object.keys(data.byOrganization || {}).length} ‡πÅ‡∏´‡πà‡∏á</p>
                    <p><strong>‡∏†‡∏≤‡∏©‡∏≤‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°:</strong> ${Object.keys(data.byLanguages || {}).join(', ')}</p>
                    <p><strong>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏¢‡∏°:</strong> ${Object.keys(data.byTopics || {}).join(', ')}</p>
                </div>
                <div style="padding: 20px; background: #e3f2fd; border-radius: 10px; margin: 10px 0;">
                    <h3>üéØ ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</h3>
                    <p>‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</p>
                    <p>‚Ä¢ ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
                    <p>‚Ä¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</p>
                </div>
            `;
        }

        function createTimelineChart(dailyData) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (charts.timeline) {
                charts.timeline.destroy();
            }

            const sortedDates = Object.keys(dailyData).sort();
            const values = sortedDates.map(date => dailyData[date]);

            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(date => new Date(date).toLocaleDateString('th-TH')),
                    datasets: [{
                        label: '‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createWeeklyChart(dailyData) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            
            if (charts.weekly) {
                charts.weekly.destroy();
            }

            // Group by week
            const weeklyData = {};
            Object.entries(dailyData).forEach(([date, count]) => {
                const week = getWeekNumber(new Date(date));
                weeklyData[week] = (weeklyData[week] || 0) + count;
            });

            charts.weekly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(weeklyData).map(week => `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${week}`),
                    datasets: [{
                        label: '‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
                        data: Object.values(weeklyData),
                        backgroundColor: '#764ba2',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createExperienceChart(experienceData) {
            const ctx = document.getElementById('experienceChart').getContext('2d');
            
            if (charts.experience) {
                charts.experience.destroy();
            }

            const labels = Object.keys(experienceData);
            const values = Object.values(experienceData);
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];

            charts.experience = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createLanguagesChart(languagesData) {
            const ctx = document.getElementById('languagesChart').getContext('2d');
            
            if (charts.languages) {
                charts.languages.destroy();
            }

            // Get top 5 languages
            const sortedLangs = Object.entries(languagesData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const labels = sortedLangs.map(([lang]) => lang);
            const values = sortedLangs.map(([,count]) => count);

            charts.languages = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏ô‡πÉ‡∏à',
                        data: values,
                        backgroundColor: '#667eea',
                        borderColor: '#764ba2',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        document.addEventListener('DOMContentLoaded', loadAnalyticsData);
    </script>
</body>
</html>
